---
phase: 01-foundation-architecture
plan: "07"
type: execute
wave: 3
depends_on:
  - "03"
files_modified:
  - src-tauri/Cargo.toml
  - src-tauri/src/bin/lulu_test_cli.rs
  - src-tauri/tests/cli_ipc.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Integration tests verify a real CLI spawn and IPC event parsing"
    - "CLI override path is respected in tests"
  artifacts:
    - path: "src-tauri/src/bin/lulu_test_cli.rs"
      provides: "Deterministic test CLI output for spawn verification"
    - path: "src-tauri/tests/cli_ipc.rs"
      provides: "Integration test for CLI spawn + IPC event parsing"
  key_links:
    - from: "src-tauri/tests/cli_ipc.rs"
      to: "src-tauri/src/bin/lulu_test_cli.rs"
      via: "CARGO_BIN_EXE_lulu_test_cli"
      pattern: "CARGO_BIN_EXE_lulu_test_cli"
    - from: "src-tauri/tests/cli_ipc.rs"
      to: "src-tauri/src/session/cli.rs"
      via: "spawn with cli_path_override"
      pattern: "spawn.*cli_path_override"
---

<objective>
Add integration tests that spawn a real CLI process and validate IPC event parsing.

Purpose: Satisfy the locked requirement for real CLI spawn + IPC verification and prevent regressions.
Output: Test CLI binary and cargo integration tests exercising spawn + parsing paths.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-architecture/01-CONTEXT.md
@.planning/phases/01-foundation-architecture/01-RESEARCH.md
@.planning/phases/01-foundation-architecture/01-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create a deterministic test CLI binary</name>
  <files>src-tauri/src/bin/lulu_test_cli.rs</files>
  <action>
1. Add a new Rust binary under src-tauri/src/bin/lulu_test_cli.rs.
2. The binary should:
   - Print a small, deterministic stream of output events (both JSON and plain text lines) to stdout.
   - Include at least one message, one tool call, and one tool result payload.
   - Exit with code 0 after emitting the stream.
3. Keep output stable so tests can assert event parsing order and types.
  </action>
  <verify>Run `cd src-tauri && cargo run --bin lulu_test_cli` and confirm output appears</verify>
  <done>Test CLI binary emits deterministic output and exits cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Add CLI spawn + IPC parsing integration test</name>
  <files>src-tauri/tests/cli_ipc.rs, src-tauri/Cargo.toml</files>
  <action>
1. Add dev-dependencies if needed in src-tauri/Cargo.toml (e.g., `tokio` for async tests, `serde_json` for parsing assertions).
2. Create src-tauri/tests/cli_ipc.rs:
   - Use `env!("CARGO_BIN_EXE_lulu_test_cli")` to locate the test binary.
   - Call the session CLI spawn path with `cli_path_override` pointing to the test binary.
   - Collect emitted `SessionEvent` values with a timeout to avoid hanging.
   - Assert expected event sequence: Message -> ToolCall -> ToolResult (and any Status events).
   - Assert `session_id`/`seq` fields are present and ordered.
3. Ensure test fails if spawn/parse pipeline breaks.
  </action>
  <verify>Run `cd src-tauri && cargo test` - integration test passes</verify>
  <done>Integration test validates real CLI spawn and IPC event parsing</done>
</task>

</tasks>

<verification>
- [ ] `cargo test` runs the CLI spawn + IPC integration test
- [ ] Test fails if the CLI override path is ignored
</verification>

<success_criteria>
Real CLI spawning and IPC event parsing are covered by integration tests using a deterministic test binary.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-architecture/01-07-SUMMARY.md`
</output>
