---
phase: 01-foundation
plan: "05"
type: execute
wave: 3
depends_on:
  - "03"
files_modified:
  - src/lib/types/session.ts
  - src/lib/stores/sessions.ts
  - src/lib/components/SessionOutput.svelte
  - src/lib/components/ToolCallBlock.svelte
  - src/lib/components/Sidebar.svelte
  - src/lib/components/MainArea.svelte
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Session output buffers message-level chunks (no token-by-token display)"
    - "Thinking content is hidden by default with a UI toggle"
    - "Tool calls render as collapsible blocks with name, args, and result"
    - "Session output state is isolated by session_id"
    - "No-activity indicator is shown when a session has no output"
  artifacts:
    - path: "src/lib/stores/sessions.ts"
      provides: "Typed session event store with buffering and isolation"
    - path: "src/lib/components/SessionOutput.svelte"
      provides: "UI rendering for messages, tool calls, and thinking"
    - path: "src/lib/components/ToolCallBlock.svelte"
      provides: "Collapsible tool call rendering"
  key_links:
    - from: "src/lib/stores/sessions.ts"
      to: "Tauri event stream"
      via: "listen('session-event', ...)"
      pattern: "session-event"
    - from: "src/lib/stores/sessions.ts"
      to: "src-tauri/src/commands/session.rs"
      via: "invoke('spawn_session', ...)"
      pattern: "invoke\(.*spawn_session"
    - from: "src/lib/components/SessionOutput.svelte"
      to: "src/lib/stores/sessions.ts"
      via: "activeSessionId + sessionEvents"
      pattern: "sessionEvents\[activeSessionId\]"
---

<objective>
Render structured session output in the UI with buffered messages, tool blocks, and hidden thinking by default.

Purpose: Enforce the Phase 1 event streaming model and client isolation in the Svelte UI.
Output: Session store + output UI that consumes typed events with message buffering.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-architecture/01-CONTEXT.md
@.planning/phases/01-foundation-architecture/01-RESEARCH.md
@.planning/phases/01-foundation-architecture/01-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build typed session store with buffering + isolation</name>
  <files>src/lib/types/session.ts, src/lib/stores/sessions.ts</files>
  <action>
1. Create src/lib/types/session.ts with frontend types mirroring Rust SessionEvent:
   - `SessionEvent` union with tagged `type` + `data` payloads (message/tool_call/tool_result/thinking/status/error).
   - Include `session_id`, `seq`, `timestamp` in each payload.
2. Implement src/lib/stores/sessions.ts:
   - `sessions`, `activeSessionId`, `sessionEvents: Record<string, SessionEvent[]>`.
   - `messageBuffers: Record<string, string>` and `appendMessage()` that buffers until `complete: true` (or on status complete), then pushes a Message event.
   - `showThinking` boolean default false (persist in localStorage).
   - `cliPathOverride` string (persist in localStorage) and pass as `cliPathOverride` to `spawn_session`.
   - `initSessionListeners()` that listens on `session-event` and routes by session_id without cross-session mixing.
  </action>
  <verify>Run `npm run lint` (or `npm run check`) and ensure types compile</verify>
  <done>Session events are buffered per session_id, thinking hidden by default, and no output mixing occurs</done>
</task>

<task type="auto">
  <name>Task 2: Render structured output with tool blocks + thinking toggle</name>
  <files>src/lib/components/SessionOutput.svelte, src/lib/components/ToolCallBlock.svelte</files>
  <action>
1. Create ToolCallBlock.svelte:
    - Use <details>/<summary> to create a collapsible block.
    - Show tool name, args (pretty-printed JSON), and result if present.
2. Update SessionOutput.svelte:
    - Read `activeSessionId`, `sessionEvents`, `showThinking` from store.
    - Render Message events as buffered blocks (not per-line streaming).
    - Render ToolCall/ToolResult using ToolCallBlock.
    - Render Thinking events only when `showThinking` is true.
    - Include a toggle control for showThinking (shadcn Switch or simple button).
    - When a session is selected but has zero events, show a subtle "No activity yet" indicator in the output area.
   </action>
  <verify>Run `npm run dev` and confirm UI compiles without runtime errors</verify>
  <done>Messages, tool calls, and thinking render in distinct blocks, and a no-activity indicator appears when output is empty</done>
</task>

<task type="auto">
  <name>Task 3: Wire session selection + CLI override input</name>
  <files>src/lib/components/Sidebar.svelte, src/lib/components/MainArea.svelte</files>
  <action>
1. Update Sidebar.svelte:
   - Render sessions list and allow click to set `activeSessionId`.
   - Add a small "CLI Path Override" input bound to `cliPathOverride` (optional).
2. Update MainArea.svelte:
   - Include SessionOutput component and display placeholder when no active session.
   - Ensure output is isolated to `activeSessionId` only.
  </action>
  <verify>Run `npm run dev` and click session entries; output switches without mixing</verify>
  <done>UI isolates output per session and exposes CLI path override input</done>
</task>

</tasks>

<verification>
- [ ] `npm run dev` renders output UI without errors
- [ ] Thinking content is hidden by default and toggle works
- [ ] Tool call blocks are collapsible and show name/args/result
- [ ] Session output does not mix across session_id
- [ ] CLI path override value is stored and passed to spawn_session
</verification>

<success_criteria>
The UI consumes typed session events, buffers message-level chunks, and renders tool/think blocks with isolation per session.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-architecture/01-05-SUMMARY.md`
</output>
