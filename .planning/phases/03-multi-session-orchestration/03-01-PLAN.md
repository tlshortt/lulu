---
phase: 03-multi-session-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/db/mod.rs
  - src-tauri/src/db/session.rs
  - src-tauri/src/session/worktree.rs
  - src-tauri/src/session/projection.rs
  - src-tauri/src/session/mod.rs
  - src-tauri/src/commands/session.rs
  - src-tauri/src/lib.rs
  - src-tauri/tests/worktree_lifecycle.rs
autonomous: true
must_haves:
  truths:
    - User-launched sessions run in isolated git worktrees instead of sharing one checkout
    - Dashboard data source returns newest-first rows with only Starting, Running, Completed, Failed statuses
    - Terminal failures appear as Failed with an inline one-line reason available to the frontend
    - App startup reconciles stale runtime/worktree state so old crashes do not leave sessions forever Running
  artifacts:
    - path: src-tauri/src/session/worktree.rs
      provides: Worktree lifecycle service for create/remove/prune/reconcile operations
    - path: src-tauri/src/session/projection.rs
      provides: Dashboard projection model with locked four-state status normalization
    - path: src-tauri/src/db/session.rs
      provides: Persistence fields and queries for worktree path, activity timestamp, and failure reason
    - path: src-tauri/src/commands/session.rs
      provides: Spawn/delete/reconcile command wiring to worktree and projection services
  key_links:
    - from: src-tauri/src/commands/session.rs
      to: src-tauri/src/session/worktree.rs
      via: create worktree before Claude process spawn
      pattern: create_worktree\(|prepare_worktree\(
    - from: src-tauri/src/commands/session.rs
      to: src-tauri/src/session/projection.rs
      via: map internal terminal outcomes to dashboard statuses
      pattern: normalize_dashboard_status\(
    - from: src-tauri/src/lib.rs
      to: src-tauri/src/session/worktree.rs
      via: startup reconciliation and prune pass
      pattern: reconcile|prune
---

<objective>
Build the backend orchestration foundation for Phase 3: per-session git worktree isolation plus a durable dashboard projection model aligned to locked list UX semantics.

Purpose: satisfy GIT-02 and establish backend truth for SESS-02/SESS-03 before UI wiring and parallel runtime hardening.
Output: worktree lifecycle service, projection/status normalization module, and startup reconciliation path.
</objective>

<execution_context>
@/Users/timothyshortt/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/timothyshortt/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-session-orchestration/03-CONTEXT.md
@.planning/phases/03-multi-session-orchestration/03-RESEARCH.md
@src-tauri/src/commands/session.rs
@src-tauri/src/db/session.rs
@src-tauri/src/db/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Add durable dashboard projection fields and locked status normalization in persistence</name>
  <files>src-tauri/src/db/mod.rs, src-tauri/src/db/session.rs, src-tauri/src/session/projection.rs</files>
  <action>Extend session persistence to store projection-critical metadata (`last_activity_at`, `failure_reason`, `worktree_path`) and expose a query that returns newest-first dashboard rows. Implement projection normalization that maps internal outcomes (including killed/interrupted/crash-like paths) into exactly `starting|running|completed|failed` for list UX. Do not expose extra dashboard statuses and do not add progress percentage fields, per locked decisions.</action>
  <verify>cd src-tauri && cargo test --test worktree_lifecycle</verify>
  <done>Backend can return dashboard rows sorted by `created_at DESC` with four-state status vocabulary, optional one-line failure reason, and activity timestamp for relative-age rendering.</done>
</task>

<task type="auto">
  <name>Implement WorktreeService and wire it into session spawn/delete lifecycle</name>
  <files>src-tauri/src/session/worktree.rs, src-tauri/src/session/mod.rs, src-tauri/src/commands/session.rs</files>
  <action>Create a dedicated `WorktreeService` wrapper around `git worktree` (`add`, `list --porcelain`, `remove`, `prune`) that creates a unique worktree per session under app-managed paths, then launches Claude in that worktree path. Ensure delete/cleanup paths remove/prune safely without touching the main checkout. Keep one worktree per session (no shared worktree reuse) to preserve isolation for 3-5 parallel sessions.</action>
  <verify>cd src-tauri && cargo test --test worktree_lifecycle -- --nocapture</verify>
  <done>Every new session gets its own worktree path, spawn uses that path as working directory, and cleanup routines can remove/prune orphaned session worktrees.</done>
</task>

<task type="auto">
  <name>Add startup reconciliation for stale running sessions and orphaned worktrees</name>
  <files>src-tauri/src/lib.rs, src-tauri/src/commands/session.rs, src-tauri/src/session/worktree.rs, src-tauri/tests/worktree_lifecycle.rs</files>
  <action>On app startup, reconcile persisted session records and git worktree state: stale `starting/running` records without active runtime should transition to `failed` with a clear failure reason, and missing/prunable worktrees should be cleaned with explicit logging. Keep reconciliation idempotent so repeated startups do not churn statuses or reorder list rows.</action>
  <verify>cd src-tauri && cargo test --test worktree_lifecycle</verify>
  <done>After restart, no abandoned session remains indefinitely running, and worktree metadata/path state is consistent with git's authoritative worktree list.</done>
</task>

</tasks>

<verification>
Run `cd src-tauri && cargo test --test worktree_lifecycle` and confirm worktree create/remove/prune plus startup reconciliation behavior passes with deterministic assertions.
</verification>

<success_criteria>
Backend creates isolated git worktrees per session, normalizes dashboard status to Starting/Running/Completed/Failed only, persists activity/failure metadata, and reconciles stale runtime/worktree state at startup.
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-session-orchestration/03-multi-session-orchestration-01-SUMMARY.md`
</output>
