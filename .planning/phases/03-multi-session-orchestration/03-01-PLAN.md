---
phase: 03-multi-session-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/db/mod.rs
  - src-tauri/src/db/session.rs
  - src-tauri/src/session/mod.rs
  - src-tauri/src/session/projection.rs
  - src-tauri/src/session/worktree.rs
  - src-tauri/src/commands/session.rs
  - src-tauri/src/lib.rs
  - src-tauri/tests/worktree_lifecycle.rs
autonomous: true
must_haves:
  truths:
    - User can launch multiple sessions and each launch uses an isolated git worktree
    - Dashboard row payloads expose only Starting, Running, Completed, Failed as user-facing statuses
    - Terminal errors are projected as Failed with one-line failure reason available for inline row display
    - After restart, stale in-flight sessions are reconciled so dashboard rows do not remain stuck in Running
  artifacts:
    - path: src-tauri/src/session/worktree.rs
      provides: Git worktree lifecycle service (create/list/remove/prune/reconcile)
    - path: src-tauri/src/session/projection.rs
      provides: Locked dashboard projection model and four-state normalization
    - path: src-tauri/src/db/session.rs
      provides: Session projection persistence/query fields (activity timestamp, failure reason, worktree path)
    - path: src-tauri/src/commands/session.rs
      provides: Session command orchestration wiring to worktree/projection services
  key_links:
    - from: src-tauri/src/commands/session.rs
      to: src-tauri/src/session/worktree.rs
      via: create worktree before spawning Claude process
      pattern: prepare_worktree|create_worktree
    - from: src-tauri/src/commands/session.rs
      to: src-tauri/src/session/projection.rs
      via: normalize internal runtime outcomes to locked dashboard statuses
      pattern: normalize_dashboard_status|project_dashboard_status
    - from: src-tauri/src/lib.rs
      to: src-tauri/src/session/worktree.rs
      via: startup reconcile and prune pass
      pattern: reconcile_worktrees|prune_worktrees|reconcile
---

<objective>
Build the backend orchestration foundation for Phase 3: per-session git worktree isolation plus durable dashboard projection data that honors locked list UX decisions.

Purpose: satisfy GIT-02 and establish backend truth for SESS-02/SESS-03 before frontend rendering and parallel-runtime hardening.
Output: worktree lifecycle service, projection/status normalization module, and startup reconciliation wiring.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-session-orchestration/03-CONTEXT.md
@.planning/phases/03-multi-session-orchestration/03-RESEARCH.md
@src-tauri/src/commands/session.rs
@src-tauri/src/db/session.rs
@src-tauri/src/db/mod.rs
@src-tauri/src/session/manager.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add locked dashboard projection persistence and normalization</name>
  <files>src-tauri/src/db/mod.rs, src-tauri/src/db/session.rs, src-tauri/src/session/projection.rs</files>
  <action>Extend session persistence to store projection-critical metadata (`last_activity_at`, `failure_reason`, `worktree_path`) and expose a newest-first dashboard query ordered by creation time. Implement normalization that maps internal outcomes (including killed/interrupted/crash variants) to exactly `Starting|Running|Completed|Failed` for dashboard payloads. Keep this projection boundary strict: no percentage progress and no extra status variants, per locked user decisions.</action>
  <verify>cd src-tauri && cargo test --test worktree_lifecycle projection_maps_internal_terminal_states_to_failed</verify>
  <done>Dashboard query returns stable newest-first rows with only four user-facing statuses and optional one-line failure reason.</done>
</task>

<task type="auto">
  <name>Task 2: Implement per-session WorktreeService and spawn/cleanup wiring</name>
  <files>src-tauri/src/session/worktree.rs, src-tauri/src/session/mod.rs, src-tauri/src/commands/session.rs</files>
  <action>Create a dedicated `WorktreeService` wrapper around `git worktree add/list/remove/prune` that creates one unique worktree per session under app-managed paths before spawn. Wire spawn/delete lifecycle so Claude always runs inside session-specific worktree path and cleanup removes/prunes safely without mutating the main checkout. Do not reuse worktrees across sessions.</action>
  <verify>cd src-tauri && cargo test --test worktree_lifecycle spawn_uses_session_specific_worktree_path</verify>
  <done>Each session launch is isolated to its own git worktree and cleanup paths safely remove/prune orphaned worktree state.</done>
</task>

<task type="auto">
  <name>Task 3: Add startup reconciliation for stale sessions and orphaned worktrees</name>
  <files>src-tauri/src/lib.rs, src-tauri/src/commands/session.rs, src-tauri/src/session/worktree.rs, src-tauri/tests/worktree_lifecycle.rs</files>
  <action>On app startup, reconcile persisted sessions with runtime/worktree reality: stale `Starting/Running` records with no active process transition to `Failed` and receive an inline-safe failure reason, and missing/prunable worktree entries are cleaned through service helpers. Keep reconciliation idempotent and preserve creation-order sorting so status changes never trigger list reordering.</action>
  <verify>cd src-tauri && cargo test --test worktree_lifecycle startup_reconcile_marks_stale_running_as_failed</verify>
  <done>Restart path clears stuck running rows and keeps worktree metadata aligned with git authoritative worktree state.</done>
</task>

</tasks>

<verification>
Run `cd src-tauri && cargo test --test worktree_lifecycle` and confirm create/remove/prune/reconcile coverage plus locked status projection behavior all pass.
</verification>

<success_criteria>
Backend creates isolated git worktrees per session, emits dashboard rows with only Starting/Running/Completed/Failed, maps terminal errors to Failed with inline-safe reason text, and reconciles stale runtime/worktree state at startup.
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-session-orchestration/03-multi-session-orchestration-01-SUMMARY.md`
</output>
