---
phase: 03-multi-session-orchestration
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - src-tauri/src/db/session.rs
  - src-tauri/src/session/manager.rs
  - src-tauri/src/session/supervisor.rs
  - src-tauri/src/session/mod.rs
  - src-tauri/src/commands/session.rs
  - src-tauri/src/bin/lulu_test_cli.rs
  - src-tauri/tests/multi_session_orchestration.rs
autonomous: true
must_haves:
  truths:
    - User can run 3-5 sessions in parallel without sessions blocking each other
    - If one session crashes or exits with terminal error, unrelated sessions continue running
    - Terminal errors map to dashboard Failed consistently while non-failed sessions remain unaffected
  artifacts:
    - path: src-tauri/src/session/supervisor.rs
      provides: Independent per-session runtime supervision and terminal guards
    - path: src-tauri/src/commands/session.rs
      provides: Multi-session spawn/terminal orchestration through supervisor integration
    - path: src-tauri/src/db/session.rs
      provides: Idempotent terminal persistence updates consumed by multi-session supervisor
    - path: src-tauri/tests/multi_session_orchestration.rs
      provides: Integration proof for 3-5 concurrent sessions and crash isolation behavior
  key_links:
    - from: src-tauri/src/commands/session.rs
      to: src-tauri/src/session/supervisor.rs
      via: register and monitor each spawned session independently
      pattern: supervisor\.|SessionSupervisor
    - from: src-tauri/src/session/supervisor.rs
      to: src-tauri/src/db/session.rs
      via: one terminal transition persistence update per session
      pattern: transition_session_terminal|update_session_status
    - from: src-tauri/src/session/supervisor.rs
      to: session-event
      via: status emit on start/terminal boundaries
      pattern: emit\("session-event"
---

<objective>
Harden runtime concurrency so multi-session execution (3-5 sessions) is truly parallel with isolated failure domains and deterministic terminal signaling.

Purpose: satisfy SESS-01 and LIFE-03 by ensuring each session has independent supervision, cancellation, and terminal transition handling while preserving locked status mapping.
Output: SessionSupervisor runtime integration and deterministic multi-session crash-isolation tests.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-session-orchestration/03-RESEARCH.md
@.planning/phases/03-multi-session-orchestration/03-01-PLAN.md
@src-tauri/src/commands/session.rs
@src-tauri/src/session/manager.rs
@src-tauri/src/session/cli.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Introduce SessionSupervisor for independent runtime domains</name>
  <files>src-tauri/src/session/supervisor.rs, src-tauri/src/session/manager.rs, src-tauri/src/session/mod.rs, src-tauri/src/commands/session.rs, src-tauri/src/db/session.rs</files>
  <action>Create `SessionSupervisor` that tracks each session with isolated process handle, terminal guard, and cancellation context so one session failure never mutates another session runtime. Keep lock scope minimal and avoid awaits while holding shared maps. Route all terminal outcomes through one reducer that persists a single terminal transition and maps terminal errors to dashboard Failed as defined in Plan 03-01 projection policy.</action>
  <verify>cd src-tauri && cargo test --test multi_session_orchestration supervisor_keeps_other_sessions_running_after_one_failure</verify>
  <done>Supervisor supports at least 5 concurrent sessions with independent start/terminal handling and no cross-session terminal state corruption.</done>
</task>

<task type="auto">
  <name>Task 2: Add integration coverage for parallel execution and crash isolation</name>
  <files>src-tauri/src/bin/lulu_test_cli.rs, src-tauri/tests/multi_session_orchestration.rs, src-tauri/src/commands/session.rs</files>
  <action>Extend fixture modes so one session fails while peers complete, then add orchestration integration tests launching 3-5 sessions concurrently and asserting: independent forward progress, one terminal transition per session, failing session maps to `Failed`, and unaffected sessions remain `Running/Completed` without interruption. Include assertions that list-order source field (`created_at`) is unchanged by terminal transition writes.</action>
  <verify>cd src-tauri && cargo test --test multi_session_orchestration</verify>
  <done>Automated tests prove crash isolation, locked failure mapping, and stable ordering semantics under mixed outcomes.</done>
</task>

</tasks>

<verification>
Run `cd src-tauri && cargo test --test multi_session_orchestration` and confirm mixed-outcome parallel session scenarios pass without flaky timing, shared-state bleed, or failure-mapping regressions.
</verification>

<success_criteria>
The runtime can sustain 3-5 simultaneous sessions where a failed/crashed session transitions to Failed without interrupting unrelated sessions.
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-session-orchestration/03-multi-session-orchestration-02-SUMMARY.md`
</output>
