---
phase: 06-persistence-history
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - src/lib/types/session.ts
  - src/lib/stores/sessions.ts
  - src/lib/components/Sidebar.svelte
  - src/lib/__tests__/sessions.dashboard.test.ts
  - src/lib/components/Sidebar.test.ts
  - src/lib/components/SessionOutput.test.ts
autonomous: true
must_haves:
  truths:
    - After reopening the app, dashboard rows default to active-first ordering, then recent, with no default filter applied.
    - Restored sessions show a subtle restored badge and active restored sessions show a subtle recovery hint at startup.
    - Restored badge clears for a session when the first new event arrives after restore.
    - User can change sort mode, the preference is remembered, and startup still applies the locked Phase 6 default ordering before normal interaction.
    - Session history replay after restart includes full timeline events (not just assistant message text).
  artifacts:
    - path: src/lib/stores/sessions.ts
      provides: restore-aware dashboard sort model, remembered sort preference handling, and full timeline hydration via `list_session_history`.
    - path: src/lib/components/Sidebar.svelte
      provides: row rendering for restored badge, startup recovery hint, and sort controls wired to store sort state.
    - path: src/lib/types/session.ts
      provides: typed frontend contracts for restore metadata, sort modes, and history timeline payloads.
    - path: src/lib/__tests__/sessions.dashboard.test.ts
      provides: store-level regressions for startup default ordering, remembered sort behavior, and restored badge-clearing lifecycle.
    - path: src/lib/components/Sidebar.test.ts
      provides: UI regressions for restored row affordances and sort-control behavior.
  key_links:
    - from: src/lib/stores/sessions.ts
      to: src-tauri/src/commands/session.rs
      via: `invoke("list_dashboard_sessions")` and `invoke("list_session_history")` hydration path for restore-aware dashboard and timeline replay
      pattern: list_dashboard_sessions|list_session_history
    - from: src/lib/components/Sidebar.svelte
      to: src/lib/stores/sessions.ts
      via: sort control updates remembered preference while startup render uses locked default restore ordering
      pattern: dashboardRows|localStorage|sort
    - from: src/lib/stores/sessions.ts
      to: src/lib/__tests__/sessions.dashboard.test.ts
      via: deterministic tests assert active-first startup sort, no default filter, and first-new-event restored badge clear
      pattern: restored|active-first|startup
---

<objective>
Implement the Phase 6 frontend restore and history UX so reopened sessions appear in the locked restore presentation and users can review complete session timelines after restart.

Purpose: complete UI-facing SESS-04 and OUT-02 behavior with strict fidelity to locked restore decisions from `06-CONTEXT.md`.
Output: restore-aware dashboard sorting/badges/hints, remembered sort preference with startup override behavior, and full timeline history hydration in the store.
</objective>

<execution_context>
@/Users/timothyshortt/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/timothyshortt/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-persistence-history/06-CONTEXT.md
@.planning/phases/06-persistence-history/06-RESEARCH.md
@.planning/phases/05-session-lifecycle-control/05-session-lifecycle-control-02-SUMMARY.md
@.planning/phases/06-persistence-history/06-persistence-history-01-SUMMARY.md
@src/lib/stores/sessions.ts
@src/lib/components/Sidebar.svelte
@src/lib/types/session.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add restore-aware dashboard sort and full history hydration in session store</name>
  <files>src/lib/types/session.ts, src/lib/stores/sessions.ts</files>
  <action>Replace message-only history loading with timeline loading from backend `list_session_history`, mapping persisted event rows back into typed `SessionEvent` entries used by SessionOutput rendering. Implement locked two-layer sort behavior in store derivations: on startup restore apply `active sessions first, then recent`; within active, tie-break by newest `created_at` first; rank interrupted with other terminal states; and keep no default filter. Add remembered user sort preference persistence (global localStorage key is acceptable by discretion) while still enforcing startup default ordering on initial reopen before subsequent user-driven sorting.</action>
  <verify>npm run test:unit -- sessions.dashboard</verify>
  <done>Store can hydrate complete timeline history from persisted events and computes dashboard row order using locked startup restore rules plus remembered user sort behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Implement restored-row badge, recovery hint, and row emphasis updates in Sidebar</name>
  <files>src/lib/components/Sidebar.svelte, src/lib/stores/sessions.ts, src/lib/types/session.ts</files>
  <action>Update sidebar row rendering so session name remains visually primary over status/recency metadata, render a subtle medium-emphasis restored badge per restored row, and render a subtle recovery hint on active-session status chips during startup restore state. Add dashboard sort controls (placement is Claude discretion) wired to store sort selection. Ensure restored badge clears after the first new post-restore event for that session and that list remains unfiltered on reopen.</action>
  <verify>npm run test:unit -- Sidebar</verify>
  <done>Sidebar visually communicates restored state per locked decisions, exposes sort control interaction, and keeps rows aligned with restore-aware ordering and no-filter behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Add frontend regressions for restore UX, startup ordering, and badge lifecycle</name>
  <files>src/lib/__tests__/sessions.dashboard.test.ts, src/lib/components/Sidebar.test.ts, src/lib/components/SessionOutput.test.ts</files>
  <action>Add deterministic tests for locked startup sort (`active-first then recent`, active tie-break by newest created), remembered sort persistence with startup override, interrupted ranking parity with terminal states, restored badge display and clear-on-first-new-event behavior, and recovery hint rendering for active restored sessions. Extend history hydration tests to prove non-message timeline events from persisted history are replayed after restart, not just assistant text.</action>
  <verify>npm run test:unit -- sessions.dashboard Sidebar SessionOutput</verify>
  <done>Frontend tests fail if restore ordering, restored affordances, or full history replay semantics drift from Phase 6 locked decisions.</done>
</task>

</tasks>

<verification>
Run `npm run test:unit -- sessions.dashboard Sidebar SessionOutput` and verify startup restore ordering, restored affordances, and history replay tests pass.
</verification>

<success_criteria>
Phase 6 UI contract is met: reopened dashboard uses locked restore ordering and indicators, restored badges clear on first new event, user sort preference is remembered without violating startup default behavior, and complete session timeline history is reviewable post-restart.
</success_criteria>

<output>
After completion, create `.planning/phases/06-persistence-history/06-persistence-history-02-SUMMARY.md`
</output>
