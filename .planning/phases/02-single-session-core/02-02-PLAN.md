---
phase: 02-single-session-core
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/lib/stores/sessions.ts
  - src/lib/types/session.ts
  - src/lib/components/NewSessionModal.svelte
  - src/lib/components/SessionOutput.svelte
  - src/lib/components/MainArea.svelte
  - src/lib/components/NewSessionModal.test.ts
  - src/lib/components/MainArea.test.ts
  - src/lib/components/SessionOutput.test.ts
  - src/lib/__tests__/sessions.isolation.test.ts
autonomous: true
must_haves:
  truths:
    - User can start a named session with custom prompt and working directory from the UI
    - User sees live stream output updates for text, thinking, tool use, and tool results
    - User sees exactly one final terminal state when the session ends
  artifacts:
    - path: src/lib/stores/sessions.ts
      provides: canonical session-event routing and listener lifecycle
    - path: src/lib/types/session.ts
      provides: frontend typed event union aligned to backend normalized payloads
    - path: src/lib/components/NewSessionModal.svelte
      provides: launch form for name/prompt/working directory
    - path: src/lib/components/SessionOutput.svelte
      provides: real-time rendering of session events and status
    - path: src/lib/components/SessionOutput.test.ts
      provides: rendering assertions for stream event categories
  key_links:
    - from: src/lib/components/NewSessionModal.svelte
      to: src/lib/stores/sessions.ts
      via: spawnSession(name,prompt,workingDir)
      pattern: spawnSession\(
    - from: src/lib/stores/sessions.ts
      to: src/lib/components/SessionOutput.svelte
      via: sessionEvents store updates
      pattern: routeSessionEvent\(|sessionEvents
    - from: src/lib/stores/sessions.ts
      to: src/lib/components/MainArea.svelte
      via: activeSessionId canonical selection
      pattern: activeSessionId
---

<objective>
Ship the Phase 2 single-session UI flow for launch, live stream rendering, and terminal status presentation.

Purpose: satisfy the user-visible half of SESS-01 partial + OUT-01 + GIT-01 using the backend contract from plan 02-01.
Output: launch modal + session store + output renderer aligned to canonical `session-event` data.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-single-session-core/02-RESEARCH.md
@.planning/phases/02-single-session-core/02-single-session-core-01-SUMMARY.md
@src/lib/stores/sessions.ts
@src/lib/components/NewSessionModal.svelte
@src/lib/components/SessionOutput.svelte
</context>

<tasks>

<task type="auto">
  <name>Finalize single-session launch UX with strict required inputs and active selection</name>
  <files>src/lib/components/NewSessionModal.svelte, src/lib/stores/sessions.ts, src/lib/components/MainArea.svelte</files>
  <action>Ensure launch requires non-empty name/prompt/working directory, trims user input, calls `spawnSession` exactly once, and sets the new session as the active view. Keep `activeSessionId` as canonical selection state (retaining `selectedSessionId` alias compatibility). Show clear validation + submit failure messages; do not add multi-session orchestration controls in this phase.</action>
  <verify>npm run test:unit -- NewSessionModal MainArea</verify>
  <done>User can launch exactly one session from the modal and immediately see it selected in main output area with no validation ambiguity.</done>
</task>

<task type="auto">
  <name>Align frontend event typing and routing with backend normalized schema</name>
  <files>src/lib/types/session.ts, src/lib/stores/sessions.ts, src/lib/components/SessionOutput.svelte</files>
  <action>Align TypeScript discriminated unions and store routing with the backend normalized event schema from 02-01, including message, thinking, tool_call, tool_result, status, and error. Route canonical behavior through `session-event`; keep legacy listener support only for compatibility and avoid duplicate terminal status appends. Preserve "thinking hidden by default" toggle behavior and maintain ordered append semantics by `seq`.</action>
  <verify>npm run test:unit -- SessionOutput sessions.isolation</verify>
  <done>While a session is running, live events appear in real time and terminal status resolves once to completed or failed when backend emits terminal state.</done>
</task>

<task type="auto">
  <name>Add frontend behavior tests for launch, streaming, and terminal state</name>
  <files>src/lib/components/NewSessionModal.test.ts, src/lib/components/MainArea.test.ts, src/lib/components/SessionOutput.test.ts, src/lib/__tests__/sessions.isolation.test.ts</files>
  <action>Create/update tests to assert: form validation + spawn arguments (including working directory), rendering for each event category, thinking toggle behavior, tool call/result pairing, and single terminal status display after completion/failure. Include regression coverage preventing duplicated terminal rows from canonical + compatibility listeners. Keep tests deterministic and aligned with existing Vitest + Testing Library patterns.</action>
  <verify>npm run check && npm run test:unit -- NewSessionModal MainArea SessionOutput sessions.isolation</verify>
  <done>Frontend test suite proves Phase 2 user-visible behavior for launch + live streaming + final state presentation.</done>
</task>

</tasks>

<verification>
Run `npm run check` and `npm run test:unit -- NewSessionModal MainArea SessionOutput sessions.isolation`; verify no duplicated terminal status rows in output rendering assertions.
</verification>

<success_criteria>
User can launch one named session with prompt + working directory, watch live structured output stream, and see final completed/failed status in the UI.
</success_criteria>

<output>
After completion, create `.planning/phases/02-single-session-core/02-single-session-core-02-SUMMARY.md`
</output>
